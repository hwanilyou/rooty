<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆì´í˜ì´ì§€</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">

    <link rel="stylesheet" href="/css/login.css">
    <link rel="stylesheet" href="/css/mypage.css">

    <script src="/js/userinfo.js"></script>
</head>
<body>

<!-- ===== í—¤ë”  ===== -->
<div layout:include="fragments/header :: headerFragment"></div>

<!-- ===== ë§ˆì´í˜ì´ì§€ ì½˜í…ì¸  ===== -->
<div class="mypage-container">
    <h1 class="mypage-title">ë§ˆì´í˜ì´ì§€</h1>
    <form id="mypage-form">
        <label for="username" class="mypage-label">ì•„ì´ë”” (ìˆ˜ì • ë¶ˆê°€)</label>
        <input type="text" id="username" class="mypage-input" disabled />

        <label for="email" class="mypage-label">ì´ë©”ì¼</label>
        <input type="email" id="email" class="mypage-input" required />

        <label for="password" class="mypage-label">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ (ì„ íƒ)</label>
        <input type="password" id="password" class="mypage-input" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" />

        <button type="submit" class="mypage-button">ì •ë³´ ìˆ˜ì •</button>
    </form>
    <button type="button" id="deleteAccountBtn" class="mypage-button mypage-delete-btn">
        ê³„ì • ì‚­ì œ
    </button>

    <div class="mypage-message" id="message"></div>
</div>

<!-- ===== ìŠ¤í¬ë¦½íŠ¸ ===== -->
<script>
    // ê´€ë¦¬ìì´ë©´ ê´€ë¦¬ì í˜ì´ì§€ë¡œ ì´ë™
    const role = localStorage.getItem("role");
    if (role === "ADMIN") {
        window.location.href = "/user/members"; // âœ… ê´€ë¦¬ì íšŒì› ê´€ë¦¬ í˜ì´ì§€ ê²½ë¡œ ìˆ˜ì •ë¨
    }

    const token = localStorage.getItem("token");
    const usernameInput = document.getElementById("username");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const messageDiv = document.getElementById("message");
    const form = document.getElementById("mypage-form");

    if (!token) {
        messageDiv.textContent = "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.";
        messageDiv.classList.add("error");
        form.style.display = "none";
    } else {
        // ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
        axios.get("/api/mypage", {
            headers: {
                Authorization: "Bearer " + token
            }
        })
            .then(response => {
                usernameInput.value = response.data.username;
                emailInput.value = response.data.email;
            })
            .catch(error => {
                console.error("ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨", error);
                messageDiv.textContent = "ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
                messageDiv.classList.add("error");
            });

        // í¼ ì œì¶œ ì‹œ ìˆ˜ì • ìš”ì²­
        form.addEventListener("submit", function(e) {
            e.preventDefault();
            const updateData = {
                email: emailInput.value,
                password: passwordInput.value
            };

            axios.put("/api/mypage", updateData, {
                headers: {
                    Authorization: "Bearer " + token
                }
            })
                .then(response => {
                    messageDiv.textContent = "ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!";
                    messageDiv.classList.remove("error");
                    passwordInput.value = "";
                })
                .catch(error => {
                    console.error("ì •ë³´ ìˆ˜ì • ì‹¤íŒ¨", error);
                    messageDiv.textContent = "ì •ë³´ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                    messageDiv.classList.add("error");
                });
        });
    }

    const deleteBtn = document.getElementById("deleteAccountBtn");
    deleteBtn.addEventListener("click", function() {
        const confirmDelete = confirm("ì •ë§ë¡œ ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        if (!confirmDelete) return;

        axios.delete("/api/mypage", {
            headers: {
                Authorization: "Bearer " + token
            }
        })
            .then(response => {
                alert("ê³„ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                localStorage.removeItem("token");
                window.location.href = "/";
            })
            .catch(error => {
                console.error("ê³„ì • ì‚­ì œ ì‹¤íŒ¨", error);
                messageDiv.textContent = "ê³„ì • ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                messageDiv.classList.add("error");
            });
    });

    console.log('ğŸ“¦ localStorage ìƒíƒœ í™•ì¸');
    console.log('token:', localStorage.getItem('token'));
    console.log('role:', localStorage.getItem('role'));
    console.log('username:', localStorage.getItem('username'));
</script>
</body>
</html>
